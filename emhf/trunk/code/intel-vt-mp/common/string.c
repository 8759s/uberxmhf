/*
 * @XMHF_LICENSE_HEADER_START@
 *
 * eXtensible, Modular Hypervisor Framework (XMHF)
 * Copyright (c) 2009-2012 Carnegie Mellon University
 * Copyright (c) 2010-2012 VDG Inc.
 * All Rights Reserved.
 *
 * Developed by: XMHF Team
 *               Carnegie Mellon University / CyLab
 *               VDG Inc.
 *               http://xmhf.org
 *
 * This file is part of the EMHF historical reference
 * codebase, and is released under the terms of the
 * GNU General Public License (GPL) version 2.
 * Please see the LICENSE file for details.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND
 * CONTRIBUTORS "AS IS" AND ANY EXPRESS OR IMPLIED WARRANTIES,
 * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF
 * MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
 * DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS
 * BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,
 * EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED
 * TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON
 * ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR
 * TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF
 * THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
 * SUCH DAMAGE.
 *
 * @XMHF_LICENSE_HEADER_END@
 */

#include <target.h>

void *memmove(void *dst_void, const void *src_void, u32 length){
  char *dst = dst_void;
  const char *src = src_void;

  if (src < dst && dst < src + length){
      // Have to copy backwards 
      src += length;
      dst += length;
      while (length--){
	     *--dst = *--src;
	     }
  }else{
      while (length--){
	     *dst++ = *src++;
	    }
  }

  return dst_void;
}


char *strchr(const char *s, int c)
{
    long d0;
    register char *__res;
    __asm__ __volatile__ (
        "   mov  %%al,%%ah  \n"
        "1: lodsb           \n"
        "   cmp  %%ah,%%al  \n"
        "   je   2f         \n"
        "   test %%al,%%al  \n"
        "   jne  1b         \n"
        "   mov  $1,%1      \n"
        "2: mov  %1,%0      \n"
        "   dec  %0         \n"
        : "=a" (__res), "=&S" (d0) : "1" (s), "0" (c) );
    return __res;
}


u32 strnlen(const char * s, u32 count){
	const char *sc;

	for (sc = s; count-- && *sc != '\0'; ++sc);
	return (u32)(sc - s);
}


void *memcpy(void * to, const void * from, u32 n){
  int d0, d1, d2;

  __asm__ __volatile__(
  	"rep ; movsl\n\t"
  	"movl %4,%%ecx\n\t"
  	"andl $3,%%ecx\n\t"
#if 1	/* want to pay 2 byte penalty for a chance to skip microcoded rep? */
  	"jz 1f\n\t"
#endif
  	"rep ; movsb\n\t"
  	"1:"
  	: "=&c" (d0), "=&D" (d1), "=&S" (d2)
  	: "0" (n/4), "g" (n), "1" ((long) to), "2" ((long) from)
  	: "memory");
  return (to);
}

void *memset (void *str, int c, u32 len){
 	ASSERT(len == 4096);
  
	/*register char *st = str;
	
  while (len-- > 0)
    *st++ = (char)c;
  return str;*/
  register u32 *st = (u32 *)str;

st[0]=0;
st[1]=0;
st[2]=0;
st[3]=0;
st[4]=0;
st[5]=0;
st[6]=0;
st[7]=0;
st[8]=0;
st[9]=0;
st[10]=0;
st[11]=0;
st[12]=0;
st[13]=0;
st[14]=0;
st[15]=0;
st[16]=0;
st[17]=0;
st[18]=0;
st[19]=0;
st[20]=0;
st[21]=0;
st[22]=0;
st[23]=0;
st[24]=0;
st[25]=0;
st[26]=0;
st[27]=0;
st[28]=0;
st[29]=0;
st[30]=0;
st[31]=0;
st[32]=0;
st[33]=0;
st[34]=0;
st[35]=0;
st[36]=0;
st[37]=0;
st[38]=0;
st[39]=0;
st[40]=0;
st[41]=0;
st[42]=0;
st[43]=0;
st[44]=0;
st[45]=0;
st[46]=0;
st[47]=0;
st[48]=0;
st[49]=0;
st[50]=0;
st[51]=0;
st[52]=0;
st[53]=0;
st[54]=0;
st[55]=0;
st[56]=0;
st[57]=0;
st[58]=0;
st[59]=0;
st[60]=0;
st[61]=0;
st[62]=0;
st[63]=0;
st[64]=0;
st[65]=0;
st[66]=0;
st[67]=0;
st[68]=0;
st[69]=0;
st[70]=0;
st[71]=0;
st[72]=0;
st[73]=0;
st[74]=0;
st[75]=0;
st[76]=0;
st[77]=0;
st[78]=0;
st[79]=0;
st[80]=0;
st[81]=0;
st[82]=0;
st[83]=0;
st[84]=0;
st[85]=0;
st[86]=0;
st[87]=0;
st[88]=0;
st[89]=0;
st[90]=0;
st[91]=0;
st[92]=0;
st[93]=0;
st[94]=0;
st[95]=0;
st[96]=0;
st[97]=0;
st[98]=0;
st[99]=0;
st[100]=0;
st[101]=0;
st[102]=0;
st[103]=0;
st[104]=0;
st[105]=0;
st[106]=0;
st[107]=0;
st[108]=0;
st[109]=0;
st[110]=0;
st[111]=0;
st[112]=0;
st[113]=0;
st[114]=0;
st[115]=0;
st[116]=0;
st[117]=0;
st[118]=0;
st[119]=0;
st[120]=0;
st[121]=0;
st[122]=0;
st[123]=0;
st[124]=0;
st[125]=0;
st[126]=0;
st[127]=0;
st[128]=0;
st[129]=0;
st[130]=0;
st[131]=0;
st[132]=0;
st[133]=0;
st[134]=0;
st[135]=0;
st[136]=0;
st[137]=0;
st[138]=0;
st[139]=0;
st[140]=0;
st[141]=0;
st[142]=0;
st[143]=0;
st[144]=0;
st[145]=0;
st[146]=0;
st[147]=0;
st[148]=0;
st[149]=0;
st[150]=0;
st[151]=0;
st[152]=0;
st[153]=0;
st[154]=0;
st[155]=0;
st[156]=0;
st[157]=0;
st[158]=0;
st[159]=0;
st[160]=0;
st[161]=0;
st[162]=0;
st[163]=0;
st[164]=0;
st[165]=0;
st[166]=0;
st[167]=0;
st[168]=0;
st[169]=0;
st[170]=0;
st[171]=0;
st[172]=0;
st[173]=0;
st[174]=0;
st[175]=0;
st[176]=0;
st[177]=0;
st[178]=0;
st[179]=0;
st[180]=0;
st[181]=0;
st[182]=0;
st[183]=0;
st[184]=0;
st[185]=0;
st[186]=0;
st[187]=0;
st[188]=0;
st[189]=0;
st[190]=0;
st[191]=0;
st[192]=0;
st[193]=0;
st[194]=0;
st[195]=0;
st[196]=0;
st[197]=0;
st[198]=0;
st[199]=0;
st[200]=0;
st[201]=0;
st[202]=0;
st[203]=0;
st[204]=0;
st[205]=0;
st[206]=0;
st[207]=0;
st[208]=0;
st[209]=0;
st[210]=0;
st[211]=0;
st[212]=0;
st[213]=0;
st[214]=0;
st[215]=0;
st[216]=0;
st[217]=0;
st[218]=0;
st[219]=0;
st[220]=0;
st[221]=0;
st[222]=0;
st[223]=0;
st[224]=0;
st[225]=0;
st[226]=0;
st[227]=0;
st[228]=0;
st[229]=0;
st[230]=0;
st[231]=0;
st[232]=0;
st[233]=0;
st[234]=0;
st[235]=0;
st[236]=0;
st[237]=0;
st[238]=0;
st[239]=0;
st[240]=0;
st[241]=0;
st[242]=0;
st[243]=0;
st[244]=0;
st[245]=0;
st[246]=0;
st[247]=0;
st[248]=0;
st[249]=0;
st[250]=0;
st[251]=0;
st[252]=0;
st[253]=0;
st[254]=0;
st[255]=0;
st[256]=0;
st[257]=0;
st[258]=0;
st[259]=0;
st[260]=0;
st[261]=0;
st[262]=0;
st[263]=0;
st[264]=0;
st[265]=0;
st[266]=0;
st[267]=0;
st[268]=0;
st[269]=0;
st[270]=0;
st[271]=0;
st[272]=0;
st[273]=0;
st[274]=0;
st[275]=0;
st[276]=0;
st[277]=0;
st[278]=0;
st[279]=0;
st[280]=0;
st[281]=0;
st[282]=0;
st[283]=0;
st[284]=0;
st[285]=0;
st[286]=0;
st[287]=0;
st[288]=0;
st[289]=0;
st[290]=0;
st[291]=0;
st[292]=0;
st[293]=0;
st[294]=0;
st[295]=0;
st[296]=0;
st[297]=0;
st[298]=0;
st[299]=0;
st[300]=0;
st[301]=0;
st[302]=0;
st[303]=0;
st[304]=0;
st[305]=0;
st[306]=0;
st[307]=0;
st[308]=0;
st[309]=0;
st[310]=0;
st[311]=0;
st[312]=0;
st[313]=0;
st[314]=0;
st[315]=0;
st[316]=0;
st[317]=0;
st[318]=0;
st[319]=0;
st[320]=0;
st[321]=0;
st[322]=0;
st[323]=0;
st[324]=0;
st[325]=0;
st[326]=0;
st[327]=0;
st[328]=0;
st[329]=0;
st[330]=0;
st[331]=0;
st[332]=0;
st[333]=0;
st[334]=0;
st[335]=0;
st[336]=0;
st[337]=0;
st[338]=0;
st[339]=0;
st[340]=0;
st[341]=0;
st[342]=0;
st[343]=0;
st[344]=0;
st[345]=0;
st[346]=0;
st[347]=0;
st[348]=0;
st[349]=0;
st[350]=0;
st[351]=0;
st[352]=0;
st[353]=0;
st[354]=0;
st[355]=0;
st[356]=0;
st[357]=0;
st[358]=0;
st[359]=0;
st[360]=0;
st[361]=0;
st[362]=0;
st[363]=0;
st[364]=0;
st[365]=0;
st[366]=0;
st[367]=0;
st[368]=0;
st[369]=0;
st[370]=0;
st[371]=0;
st[372]=0;
st[373]=0;
st[374]=0;
st[375]=0;
st[376]=0;
st[377]=0;
st[378]=0;
st[379]=0;
st[380]=0;
st[381]=0;
st[382]=0;
st[383]=0;
st[384]=0;
st[385]=0;
st[386]=0;
st[387]=0;
st[388]=0;
st[389]=0;
st[390]=0;
st[391]=0;
st[392]=0;
st[393]=0;
st[394]=0;
st[395]=0;
st[396]=0;
st[397]=0;
st[398]=0;
st[399]=0;
st[400]=0;
st[401]=0;
st[402]=0;
st[403]=0;
st[404]=0;
st[405]=0;
st[406]=0;
st[407]=0;
st[408]=0;
st[409]=0;
st[410]=0;
st[411]=0;
st[412]=0;
st[413]=0;
st[414]=0;
st[415]=0;
st[416]=0;
st[417]=0;
st[418]=0;
st[419]=0;
st[420]=0;
st[421]=0;
st[422]=0;
st[423]=0;
st[424]=0;
st[425]=0;
st[426]=0;
st[427]=0;
st[428]=0;
st[429]=0;
st[430]=0;
st[431]=0;
st[432]=0;
st[433]=0;
st[434]=0;
st[435]=0;
st[436]=0;
st[437]=0;
st[438]=0;
st[439]=0;
st[440]=0;
st[441]=0;
st[442]=0;
st[443]=0;
st[444]=0;
st[445]=0;
st[446]=0;
st[447]=0;
st[448]=0;
st[449]=0;
st[450]=0;
st[451]=0;
st[452]=0;
st[453]=0;
st[454]=0;
st[455]=0;
st[456]=0;
st[457]=0;
st[458]=0;
st[459]=0;
st[460]=0;
st[461]=0;
st[462]=0;
st[463]=0;
st[464]=0;
st[465]=0;
st[466]=0;
st[467]=0;
st[468]=0;
st[469]=0;
st[470]=0;
st[471]=0;
st[472]=0;
st[473]=0;
st[474]=0;
st[475]=0;
st[476]=0;
st[477]=0;
st[478]=0;
st[479]=0;
st[480]=0;
st[481]=0;
st[482]=0;
st[483]=0;
st[484]=0;
st[485]=0;
st[486]=0;
st[487]=0;
st[488]=0;
st[489]=0;
st[490]=0;
st[491]=0;
st[492]=0;
st[493]=0;
st[494]=0;
st[495]=0;
st[496]=0;
st[497]=0;
st[498]=0;
st[499]=0;
st[500]=0;
st[501]=0;
st[502]=0;
st[503]=0;
st[504]=0;
st[505]=0;
st[506]=0;
st[507]=0;
st[508]=0;
st[509]=0;
st[510]=0;
st[511]=0;
st[512]=0;
st[513]=0;
st[514]=0;
st[515]=0;
st[516]=0;
st[517]=0;
st[518]=0;
st[519]=0;
st[520]=0;
st[521]=0;
st[522]=0;
st[523]=0;
st[524]=0;
st[525]=0;
st[526]=0;
st[527]=0;
st[528]=0;
st[529]=0;
st[530]=0;
st[531]=0;
st[532]=0;
st[533]=0;
st[534]=0;
st[535]=0;
st[536]=0;
st[537]=0;
st[538]=0;
st[539]=0;
st[540]=0;
st[541]=0;
st[542]=0;
st[543]=0;
st[544]=0;
st[545]=0;
st[546]=0;
st[547]=0;
st[548]=0;
st[549]=0;
st[550]=0;
st[551]=0;
st[552]=0;
st[553]=0;
st[554]=0;
st[555]=0;
st[556]=0;
st[557]=0;
st[558]=0;
st[559]=0;
st[560]=0;
st[561]=0;
st[562]=0;
st[563]=0;
st[564]=0;
st[565]=0;
st[566]=0;
st[567]=0;
st[568]=0;
st[569]=0;
st[570]=0;
st[571]=0;
st[572]=0;
st[573]=0;
st[574]=0;
st[575]=0;
st[576]=0;
st[577]=0;
st[578]=0;
st[579]=0;
st[580]=0;
st[581]=0;
st[582]=0;
st[583]=0;
st[584]=0;
st[585]=0;
st[586]=0;
st[587]=0;
st[588]=0;
st[589]=0;
st[590]=0;
st[591]=0;
st[592]=0;
st[593]=0;
st[594]=0;
st[595]=0;
st[596]=0;
st[597]=0;
st[598]=0;
st[599]=0;
st[600]=0;
st[601]=0;
st[602]=0;
st[603]=0;
st[604]=0;
st[605]=0;
st[606]=0;
st[607]=0;
st[608]=0;
st[609]=0;
st[610]=0;
st[611]=0;
st[612]=0;
st[613]=0;
st[614]=0;
st[615]=0;
st[616]=0;
st[617]=0;
st[618]=0;
st[619]=0;
st[620]=0;
st[621]=0;
st[622]=0;
st[623]=0;
st[624]=0;
st[625]=0;
st[626]=0;
st[627]=0;
st[628]=0;
st[629]=0;
st[630]=0;
st[631]=0;
st[632]=0;
st[633]=0;
st[634]=0;
st[635]=0;
st[636]=0;
st[637]=0;
st[638]=0;
st[639]=0;
st[640]=0;
st[641]=0;
st[642]=0;
st[643]=0;
st[644]=0;
st[645]=0;
st[646]=0;
st[647]=0;
st[648]=0;
st[649]=0;
st[650]=0;
st[651]=0;
st[652]=0;
st[653]=0;
st[654]=0;
st[655]=0;
st[656]=0;
st[657]=0;
st[658]=0;
st[659]=0;
st[660]=0;
st[661]=0;
st[662]=0;
st[663]=0;
st[664]=0;
st[665]=0;
st[666]=0;
st[667]=0;
st[668]=0;
st[669]=0;
st[670]=0;
st[671]=0;
st[672]=0;
st[673]=0;
st[674]=0;
st[675]=0;
st[676]=0;
st[677]=0;
st[678]=0;
st[679]=0;
st[680]=0;
st[681]=0;
st[682]=0;
st[683]=0;
st[684]=0;
st[685]=0;
st[686]=0;
st[687]=0;
st[688]=0;
st[689]=0;
st[690]=0;
st[691]=0;
st[692]=0;
st[693]=0;
st[694]=0;
st[695]=0;
st[696]=0;
st[697]=0;
st[698]=0;
st[699]=0;
st[700]=0;
st[701]=0;
st[702]=0;
st[703]=0;
st[704]=0;
st[705]=0;
st[706]=0;
st[707]=0;
st[708]=0;
st[709]=0;
st[710]=0;
st[711]=0;
st[712]=0;
st[713]=0;
st[714]=0;
st[715]=0;
st[716]=0;
st[717]=0;
st[718]=0;
st[719]=0;
st[720]=0;
st[721]=0;
st[722]=0;
st[723]=0;
st[724]=0;
st[725]=0;
st[726]=0;
st[727]=0;
st[728]=0;
st[729]=0;
st[730]=0;
st[731]=0;
st[732]=0;
st[733]=0;
st[734]=0;
st[735]=0;
st[736]=0;
st[737]=0;
st[738]=0;
st[739]=0;
st[740]=0;
st[741]=0;
st[742]=0;
st[743]=0;
st[744]=0;
st[745]=0;
st[746]=0;
st[747]=0;
st[748]=0;
st[749]=0;
st[750]=0;
st[751]=0;
st[752]=0;
st[753]=0;
st[754]=0;
st[755]=0;
st[756]=0;
st[757]=0;
st[758]=0;
st[759]=0;
st[760]=0;
st[761]=0;
st[762]=0;
st[763]=0;
st[764]=0;
st[765]=0;
st[766]=0;
st[767]=0;
st[768]=0;
st[769]=0;
st[770]=0;
st[771]=0;
st[772]=0;
st[773]=0;
st[774]=0;
st[775]=0;
st[776]=0;
st[777]=0;
st[778]=0;
st[779]=0;
st[780]=0;
st[781]=0;
st[782]=0;
st[783]=0;
st[784]=0;
st[785]=0;
st[786]=0;
st[787]=0;
st[788]=0;
st[789]=0;
st[790]=0;
st[791]=0;
st[792]=0;
st[793]=0;
st[794]=0;
st[795]=0;
st[796]=0;
st[797]=0;
st[798]=0;
st[799]=0;
st[800]=0;
st[801]=0;
st[802]=0;
st[803]=0;
st[804]=0;
st[805]=0;
st[806]=0;
st[807]=0;
st[808]=0;
st[809]=0;
st[810]=0;
st[811]=0;
st[812]=0;
st[813]=0;
st[814]=0;
st[815]=0;
st[816]=0;
st[817]=0;
st[818]=0;
st[819]=0;
st[820]=0;
st[821]=0;
st[822]=0;
st[823]=0;
st[824]=0;
st[825]=0;
st[826]=0;
st[827]=0;
st[828]=0;
st[829]=0;
st[830]=0;
st[831]=0;
st[832]=0;
st[833]=0;
st[834]=0;
st[835]=0;
st[836]=0;
st[837]=0;
st[838]=0;
st[839]=0;
st[840]=0;
st[841]=0;
st[842]=0;
st[843]=0;
st[844]=0;
st[845]=0;
st[846]=0;
st[847]=0;
st[848]=0;
st[849]=0;
st[850]=0;
st[851]=0;
st[852]=0;
st[853]=0;
st[854]=0;
st[855]=0;
st[856]=0;
st[857]=0;
st[858]=0;
st[859]=0;
st[860]=0;
st[861]=0;
st[862]=0;
st[863]=0;
st[864]=0;
st[865]=0;
st[866]=0;
st[867]=0;
st[868]=0;
st[869]=0;
st[870]=0;
st[871]=0;
st[872]=0;
st[873]=0;
st[874]=0;
st[875]=0;
st[876]=0;
st[877]=0;
st[878]=0;
st[879]=0;
st[880]=0;
st[881]=0;
st[882]=0;
st[883]=0;
st[884]=0;
st[885]=0;
st[886]=0;
st[887]=0;
st[888]=0;
st[889]=0;
st[890]=0;
st[891]=0;
st[892]=0;
st[893]=0;
st[894]=0;
st[895]=0;
st[896]=0;
st[897]=0;
st[898]=0;
st[899]=0;
st[900]=0;
st[901]=0;
st[902]=0;
st[903]=0;
st[904]=0;
st[905]=0;
st[906]=0;
st[907]=0;
st[908]=0;
st[909]=0;
st[910]=0;
st[911]=0;
st[912]=0;
st[913]=0;
st[914]=0;
st[915]=0;
st[916]=0;
st[917]=0;
st[918]=0;
st[919]=0;
st[920]=0;
st[921]=0;
st[922]=0;
st[923]=0;
st[924]=0;
st[925]=0;
st[926]=0;
st[927]=0;
st[928]=0;
st[929]=0;
st[930]=0;
st[931]=0;
st[932]=0;
st[933]=0;
st[934]=0;
st[935]=0;
st[936]=0;
st[937]=0;
st[938]=0;
st[939]=0;
st[940]=0;
st[941]=0;
st[942]=0;
st[943]=0;
st[944]=0;
st[945]=0;
st[946]=0;
st[947]=0;
st[948]=0;
st[949]=0;
st[950]=0;
st[951]=0;
st[952]=0;
st[953]=0;
st[954]=0;
st[955]=0;
st[956]=0;
st[957]=0;
st[958]=0;
st[959]=0;
st[960]=0;
st[961]=0;
st[962]=0;
st[963]=0;
st[964]=0;
st[965]=0;
st[966]=0;
st[967]=0;
st[968]=0;
st[969]=0;
st[970]=0;
st[971]=0;
st[972]=0;
st[973]=0;
st[974]=0;
st[975]=0;
st[976]=0;
st[977]=0;
st[978]=0;
st[979]=0;
st[980]=0;
st[981]=0;
st[982]=0;
st[983]=0;
st[984]=0;
st[985]=0;
st[986]=0;
st[987]=0;
st[988]=0;
st[989]=0;
st[990]=0;
st[991]=0;
st[992]=0;
st[993]=0;
st[994]=0;
st[995]=0;
st[996]=0;
st[997]=0;
st[998]=0;
st[999]=0;
st[1000]=0;
st[1001]=0;
st[1002]=0;
st[1003]=0;
st[1004]=0;
st[1005]=0;
st[1006]=0;
st[1007]=0;
st[1008]=0;
st[1009]=0;
st[1010]=0;
st[1011]=0;
st[1012]=0;
st[1013]=0;
st[1014]=0;
st[1015]=0;
st[1016]=0;
st[1017]=0;
st[1018]=0;
st[1019]=0;
st[1020]=0;
st[1021]=0;
st[1022]=0;
st[1023]=0;
                           
}


u32 strncmp(u8 * cs, u8 * ct, u32 count)
{
        int res;
        int d0, d1, d2;
        __asm__ __volatile__( "1:\tdecl %3\n\t"
                "js 2f\n\t"
                "lodsb\n\t"
                "scasb\n\t"
                "jne 3f\n\t" 
                "testb %%al,%%al\n\t"
                "jne 1b\n"
                "2:\txorl %%eax,%%eax\n\t"
                "jmp 4f\n"
                "3:\tsbbl %%eax,%%eax\n\t"
                "orb $1,%%al\n"
                "4:"
                :"=a" (res), "=&S" (d0), "=&D" (d1), "=&c" (d2)
                :"1" (cs),"2" (ct),"3" (count)
                :"memory");
        return (u32)res;
}

