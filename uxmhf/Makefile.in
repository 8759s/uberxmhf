######
# top-level Makefile for XMHF
# author: amit vasudevan (amitvasudevan@acm.org)
######

include ./uxmhf-common.mk



######
# uXMHF build variables
######

## bootloader source path
export XMHF_BOOTLOADER_SRC := $(realpath $(XMHF_DIR)/xmhf-bootloader)

## uXMHF specific libraries
export LIBXMHFDEBUG_SRC := $(realpath $(XMHF_DIR)/libs/libxmhfdebug)
export LIBXMHFGEEC_SRC := $(realpath $(XMHF_DIR)/libs/libxmhfgeec)

## uobj source paths and count
export XMHF_SLAB_DIRS := $(shell awk -F, '{print $$1}' $(XMHF_DIR)/UOBJLIST)
XMHF_SLAB_NAMES := $(notdir $(XMHF_SLAB_DIRS))
export XMHF_SLAB_TOTAL := $(shell wc -l < $(XMHF_DIR)/UOBJLIST)




######
# top-level build targets
######


######
# target all
.PHONY: all
all: uxmhf-libs uxmhf-uobjsbuild


######
# uxmhf-libs build

.PHONY: _libxmhfdebug
_libxmhfdebug:
	@echo building libxmhfdebug...
	$(MKDIR) -p $(XMHF_LIBS_OBJECTS_DIR)
	cd $(XMHF_LIBS_OBJECTS_DIR) &&	$(MAKE) -f $(LIBXMHFDEBUG_SRC)/Makefile -w all
	@echo libxmhfdebug built sucessfully.


.PHONY: _libxmhfgeec
_libxmhfgeec:
	@echo building libxmhfgeec...
	$(MKDIR) -p $(XMHF_LIBS_OBJECTS_DIR)
	cd $(XMHF_LIBS_OBJECTS_DIR) &&	$(MAKE) -f $(LIBXMHFGEEC_SRC)/Makefile -w all
	@echo libxmhfgeec built sucessfully.
	

.PHONY: uxmhf-libs
uxmhf-libs: _libxmhfdebug _libxmhfgeec



######
# uxmhf uobj manifest/infotable related build harness


.PHONY: _uobjs_preprocessmanifests
_uobjs_preprocessmanifests:
	mkdir -p $(XMHF_OBJDIR)
	@for i in $(XMHF_SLAB_NAMES); \
	do \
		(cd $(XMHF_OBJDIR) && echo "Prepping uobj manifest for $$i..." && $(CP) -f $(XMHF_DIR)/xmhf-uobjs/$$i/$$i.gsm $$i.gsm.c && $(CCERT) -E $(CCERT_CFLAGS) -D__ASSEMBLY__ $$i.gsm.c >$(XMHF_DIR)/xmhf-uobjs/$$i/$$i.gsm.pp) || exit 1; \
	done;
	@echo uobj manifests prepped

.PHONY: _uobjs_configureandgenerateuobjinfonoexports
_uobjs_configureandgenerateuobjinfonoexports: _uobjs_preprocessmanifests
	cd $(XMHF_DIR) && $(FRAMAC) -load-module $(USPARK_INSTALL_TOOLSDIR)/Umf -umf-uobjlist $(XMHF_DIR)/UOBJLIST -umf-outuobjinfotable $(XMHF_OBJDIR)/uobjinfotable.c -umf-outlinkerscript $(XMHF_OBJDIR)/xmhf.lscript -umf-loadaddr $(XMHF_CONFIG_LOADADDR) -umf-loadmaxsize $(XMHF_CONFIG_LOADMAXSIZE) -umf-totaluhuobjs $(XMHFGEEC_TOTAL_UHSLABS) -umf-maxincldevlistentries $(XMHF_CONFIG_MAX_INCLDEVLIST_ENTRIES) -umf-maxexcldevlistentries $(XMHF_CONFIG_MAX_EXCLDEVLIST_ENTRIES) -umf-maxmemoffsetentries $(XMHF_CONFIG_MAX_MEMOFFSET_ENTRIES)

.PHONY: _uobjs_generateuobjinfoexports
_uobjs_generateuobjinfoexports: _uobjs_preprocessmanifests
	@echo generating uobj info table with memoffsets...
	cd $(XMHF_DIR) && $(FRAMAC) -load-module $(USPARK_INSTALL_TOOLSDIR)/Umf -umf-uobjlist $(XMHF_DIR)/UOBJLIST -umf-outuobjinfotable $(XMHF_OBJDIR)/uobjinfotable.c -umf-outlinkerscript $(XMHF_OBJDIR)/xmhf.lscript -umf-loadaddr $(XMHF_CONFIG_LOADADDR) -umf-loadmaxsize $(XMHF_CONFIG_LOADMAXSIZE) -umf-totaluhuobjs $(XMHFGEEC_TOTAL_UHSLABS) -umf-maxincldevlistentries $(XMHF_CONFIG_MAX_INCLDEVLIST_ENTRIES) -umf-maxexcldevlistentries $(XMHF_CONFIG_MAX_EXCLDEVLIST_ENTRIES) -umf-maxmemoffsetentries $(XMHF_CONFIG_MAX_MEMOFFSET_ENTRIES) -umf-memoffsets
	@echo uobj info table with memoffsets ready.
	
.PHONY: uobjinfotable_build
uobjinfotable_build:
	@echo building uobjinfotable build...
	$(MKDIR) -p $(XMHF_OBJDIR)
	cd $(XMHF_OBJDIR) && $(CCERT) -c $(CCERT_CFLAGS) -o $(XMHF_OBJDIR)/uobjinfotable.o uobjinfotable.c
	@echo uobjinfotable built sucessfully.

	
	
######
# uxmhf uobj build
	
.PHONY: uxmhf-uobjsbuild
uxmhf-uobjsbuild: uobjs_buildpass1 uobjs_buildpass2

.PHONY: uobjs_buildpass1
uobjs_buildpass1: _uobjs_configureandgenerateuobjinfonoexports uobjinfotable_build 
	@echo Building uobjs - pass1...
	@for i in $(XMHF_SLAB_DIRS); \
	do \
		(cd $(XMHF_OBJDIR) &&	echo "Making all in $$i..." && $(MAKE) -f $(XMHF_DIR)/$$i/Makefile -w all) || exit 1; \
	done;
	@echo uobjs build pass1 SUCCESS

.PHONY: uobjs_buildpass2
uobjs_buildpass2: _uobjs_generateuobjinfoexports uobjinfotable_build
	@echo Building uobjs - pass2...
	@for i in $(XMHF_SLAB_DIRS); \
	do \
		(cd $(XMHF_OBJDIR) &&	echo "Making all in $$i..." && $(MAKE) -f $(XMHF_DIR)/$$i/Makefile -w linkslabbin) || exit 1; \
	done;
	@echo uobjs build pass2 SUCCESS



	


	
######
# uxmhf cleanup targets
	
.PHONY: clean 
clean:
	#$(RM) -f $(XMHF_DIR)/uxmhf/xmhf-uobjs/geec_sentinel/__geec_sentinel_autogendata_slabinfotable
	$(RM) -rf $(XMHF_OBJDIR)

# http://www.gnu.org/software/automake/manual/automake.html#Clean
distclean: clean
	$(RM) config.log config.status
	$(RM) -rf Makefile


	
	
######
# uxmhf autoconf targets

Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

configure: configure.ac
	autoconf --output=configure configure.ac

