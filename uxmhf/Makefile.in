######
# top-level Makefile for XMHF
# author: amit vasudevan (amitvasudevan@acm.org)
######

include ./uxmhf-common.mk



######
# uXMHF build variables
######

## bootloader source path
export XMHF_BOOTLOADER_SRC := $(realpath $(XMHF_DIR)/xmhf-bootloader)

## uXMHF specific libraries
export LIBXMHFDEBUG_SRC := $(realpath $(XMHF_DIR)/libs/libxmhfdebug)
export LIBXMHFGEEC_SRC := $(realpath $(XMHF_DIR)/libs/libxmhfgeec)

## uobj source paths and count
export XMHF_SLAB_DIRS := $(shell awk -F, '{print $$1}' $(XMHF_DIR)/UOBJLIST)
XMHF_SLAB_NAMES := $(notdir $(XMHF_SLAB_DIRS))
export XMHF_SLAB_TOTAL := $(shell wc -l < $(XMHF_DIR)/UOBJLIST)




######
# top-level build targets
######


.PHONY: _libxmhfdebug
_libxmhfdebug:
	@echo building libxmhfdebug...
	$(MKDIR) -p $(XMHF_LIBS_OBJECTS_DIR)
	cd $(XMHF_LIBS_OBJECTS_DIR) &&	$(MAKE) -f $(LIBXMHFDEBUG_SRC)/Makefile -w all
	@echo libxmhfdebug built sucessfully.


.PHONY: _libxmhfgeec
_libxmhfgeec:
	@echo building libxmhfgeec...
	$(MKDIR) -p $(XMHF_LIBS_OBJECTS_DIR)
	cd $(XMHF_LIBS_OBJECTS_DIR) &&	$(MAKE) -f $(LIBXMHFGEEC_SRC)/Makefile -w all
	@echo libxmhfgeec built sucessfully.
	
	

.PHONY: uxmhf-libs
uxmhf-libs: _libxmhfdebug _libxmhfgeec




.PHONY: clean 
clean:
	#$(RM) -f $(XMHF_DIR)/uxmhf/xmhf-uobjs/geec_sentinel/__geec_sentinel_autogendata_slabinfotable
	$(RM) -rf $(XMHF_OBJDIR)

# http://www.gnu.org/software/automake/manual/automake.html#Clean
distclean: clean
	$(RM) config.log config.status
	$(RM) -rf Makefile


#-----autoconf rules
Makefile: Makefile.in config.status
	./config.status $@

config.status: configure
	./config.status --recheck

configure: configure.ac
	autoconf --output=configure configure.ac

