<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
<title>W5300 - SOCKET APIs: main.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
<link href="tabs.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.5.6 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
    </ul>
  </div>
<h1>main.c</h1><a href="main_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00034"></a>00034 <span class="preprocessor">#include "main.h"</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include "xscale.h"</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include "<a class="code" href="socket_8h.html" title=" WIZnet SOCKET API function definition ">socket.h</a>"</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 LOADER_STATUS   status;           <span class="comment">// for serial port</span>
<a name="l00040"></a>00040 
<a name="l00041"></a>00041 <span class="keywordtype">void</span> InitXHyper255A(<span class="keywordtype">void</span>);       <span class="comment">// Intialize MCU</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">/* Definition of example code */</span>
<a name="l00044"></a>00044 <span class="keywordtype">void</span>     <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(<a class="code" href="types_8h.html#302434b7916f66d677e9c6f13515de3e" title="The SOCKET data type.">SOCKET</a> s, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> port, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* buf,<a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mode);
<a name="l00045"></a>00045 <span class="keywordtype">void</span>     <a class="code" href="main_8c.html#a5f07c61e1d5f459a8d6ea62c70449ad" title="&amp;quot;TCP CLIENT&amp;quot; loopback program.">loopback_tcpc</a>(<a class="code" href="types_8h.html#302434b7916f66d677e9c6f13515de3e" title="The SOCKET data type.">SOCKET</a> s, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* addr, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> port, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* buf,<a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mode);
<a name="l00046"></a>00046 <span class="keywordtype">void</span>     <a class="code" href="main_8c.html#ed2243d169a9c70157f547f7ab650dc8" title="UDP loopback program.">loopback_udp</a>(<a class="code" href="types_8h.html#302434b7916f66d677e9c6f13515de3e" title="The SOCKET data type.">SOCKET</a> s, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> port, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* buf, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mode);
<a name="l00047"></a>00047  
<a name="l00048"></a>00048 
<a name="l00055"></a><a class="code" href="main_8c.html#9a88639b57af45dfd4b61ca8021a8c03">00055</a> <span class="keywordtype">void</span> <a class="code" href="main_8c.html#9a88639b57af45dfd4b61ca8021a8c03" title="It executes example program such as loopback_tcps(), loopback_tcpc(), and loopback_udp()...">Main</a>()
<a name="l00056"></a>00056 {
<a name="l00057"></a>00057    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> tx_mem_conf[8] = {8,8,8,8,8,8,8,8};          <span class="comment">// for setting TMSR regsiter</span>
<a name="l00058"></a>00058    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> rx_mem_conf[8] = {8,8,8,8,8,8,8,8};          <span class="comment">// for setting RMSR regsiter</span>
<a name="l00059"></a>00059    
<a name="l00060"></a>00060    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> * data_buf = (<a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> *) 0xA10E0000;         <span class="comment">// buffer for loopack data</span>
<a name="l00061"></a>00061    
<a name="l00062"></a>00062    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> ip[4] = {192,168,111,200};                   <span class="comment">// for setting SIP register</span>
<a name="l00063"></a>00063    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> gw[4] = {192,168,111,1};                     <span class="comment">// for setting GAR register</span>
<a name="l00064"></a>00064    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> sn[4] = {255,255,255,0};                     <span class="comment">// for setting SUBR register</span>
<a name="l00065"></a>00065    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> mac[6] = {0x00,0x08,0xDC,0x00,111,200};      <span class="comment">// for setting SHAR register</span>
<a name="l00066"></a>00066    
<a name="l00067"></a>00067    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> serverip[4] = {192,168,111,78};              <span class="comment">// "TCP SERVER" IP address for loopback_tcpc()</span>
<a name="l00068"></a>00068    
<a name="l00069"></a>00069    status.terminalSpeed = SERIAL_SPEED;
<a name="l00070"></a>00070    status.downloadSpeed = SERIAL_DOWNLOAD_SPEED;
<a name="l00071"></a>00071    
<a name="l00072"></a>00072    data_buf = (<a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>*)0xA10F0000;                       
<a name="l00073"></a>00073    
<a name="l00074"></a>00074    InitXHyper255A();                                  <span class="comment">// initiate MCU</span>
<a name="l00075"></a>00075    SerialInit(status.terminalSpeed);                  <span class="comment">// initiate serial port</span>
<a name="l00076"></a>00076    
<a name="l00077"></a>00077    <span class="comment">/* initiate W5300 */</span>
<a name="l00078"></a>00078    <a class="code" href="w5300_8h.html#062a65a13ef9e7bf1012592fc2b3d866" title="It initializes W5300.">iinchip_init</a>();  
<a name="l00079"></a>00079 
<a name="l00080"></a>00080    <span class="comment">/* allocate internal TX/RX Memory of W5300 */</span>
<a name="l00081"></a>00081    <span class="keywordflow">if</span>(!<a class="code" href="w5300_8h.html#25d39eb38ed55eef1705ee0cbc30c5f0" title="It allocate internal TX/RX memory of each SOCKET.">sysinit</a>(tx_mem_conf,rx_mem_conf))           
<a name="l00082"></a>00082    {
<a name="l00083"></a>00083       printf(<span class="stringliteral">"MEMORY CONFIG ERR.\r\n"</span>);
<a name="l00084"></a>00084       <span class="keywordflow">while</span>(1);
<a name="l00085"></a>00085    }
<a name="l00086"></a>00086 
<a name="l00087"></a>00087    <span class="comment">//setMR(getMR()|MR_FS);                            // If Little-endian, set MR_FS.</span>
<a name="l00088"></a>00088    
<a name="l00089"></a>00089    <a class="code" href="w5300_8h.html#165873a447be472cccdc4d6432955de8" title="It sets the source hardware address.">setSHAR</a>(mac);                                      <span class="comment">// set source hardware address</span>
<a name="l00090"></a>00090    
<a name="l00091"></a>00091 <span class="preprocessor">   #ifdef __DEF_IINCHIP_PPP__</span>
<a name="l00092"></a>00092 <span class="preprocessor"></span>      <span class="keywordflow">if</span>(<a class="code" href="w5300_8h.html#c53b0f24d1c54eb1b2cd591bfa410968" title="It initializes to PPPoE of W5300.">pppinit</a>((<a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>*)<span class="stringliteral">"test01"</span>, 6, (<a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>*)<span class="stringliteral">"pppoe1000"</span>, 9)!=1)
<a name="l00093"></a>00093       {
<a name="l00094"></a>00094          printf(<span class="stringliteral">"PPPoE fail.\r\n"</span>);
<a name="l00095"></a>00095          <span class="keywordflow">while</span>(1);
<a name="l00096"></a>00096       }
<a name="l00097"></a>00097       <a class="code" href="socket_8h.html#4243cf1670c850a7bf1e77799afdc53f" title="Close a SOCKET.">close</a>(0);
<a name="l00098"></a>00098 <span class="preprocessor">   #else</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>      <span class="comment">/* configure network information */</span>
<a name="l00100"></a>00100       <a class="code" href="w5300_8h.html#b70d7d44fd967119e4414f0fd7aa67f2" title="It sets the gateway IP address.">setGAR</a>(gw);                                     <span class="comment">// set gateway IP address</span>
<a name="l00101"></a>00101       <a class="code" href="w5300_8h.html#13a95b81de9ef245627c23c15a8954b3" title="It sets the subnet mask address.">setSUBR</a>(sn);                                    <span class="comment">// set subnet mask address</span>
<a name="l00102"></a>00102       <a class="code" href="w5300_8h.html#ed4c615f6d139d1d4cd50ee845c8c068" title="It sets the source IP address.">setSIPR</a>(ip);                                    <span class="comment">// set source IP address</span>
<a name="l00103"></a>00103 <span class="preprocessor">   #endif</span>
<a name="l00104"></a>00104 <span class="preprocessor"></span>   
<a name="l00105"></a>00105    <span class="comment">/* verify network information */</span>
<a name="l00106"></a>00106    <a class="code" href="w5300_8h.html#929d98d0f61ba8e20c1a11d915e3cc5a" title="It gets the source hardware address.">getSHAR</a>(mac);                                      <span class="comment">// get source hardware address </span>
<a name="l00107"></a>00107    <a class="code" href="w5300_8h.html#6d9afb44c6f27a42aecbc16a63892ec1" title="It gets the gateway IP address.">getGAR</a>(gw);                                        <span class="comment">// get gateway IP address      </span>
<a name="l00108"></a>00108    <a class="code" href="w5300_8h.html#3c29956d5e0d9bc04a37297f36d6973a" title="It gets the subnet mask address.">getSUBR</a>(sn);                                       <span class="comment">// get subnet mask address     </span>
<a name="l00109"></a>00109    <a class="code" href="w5300_8h.html#0a783661ee3d843dcca4b2ec2f31b076" title="It gets the source IP address.">getSIPR</a>(ip);                                       <span class="comment">// get source IP address       </span>
<a name="l00110"></a>00110    
<a name="l00111"></a>00111    printf(<span class="stringliteral">"SHAR : %02x:%02x:%02x:%02x:%02x:%02x\r\n"</span>,mac[0],mac[1],mac[2],mac[3],mac[4],mac[5]);
<a name="l00112"></a>00112    printf(<span class="stringliteral">"GWR  : %d.%d.%d.%d\r\n"</span>,gw[0],gw[1],gw[2],gw[3]);
<a name="l00113"></a>00113    printf(<span class="stringliteral">"SUBR : %d.%d.%d.%d\r\n"</span>,sn[0],sn[1],sn[2],sn[3]);
<a name="l00114"></a>00114    printf(<span class="stringliteral">"SIPR : %d.%d.%d.%d\r\n"</span>,ip[0],ip[1],ip[2],ip[3]);
<a name="l00115"></a>00115    
<a name="l00116"></a>00116    <span class="keywordflow">while</span>(1)
<a name="l00117"></a>00117    {
<a name="l00118"></a>00118       <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(0,5000,data_buf,0);
<a name="l00119"></a>00119       <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(1,5000,data_buf,0);
<a name="l00120"></a>00120       <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(2,5000,data_buf,0);
<a name="l00121"></a>00121       <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(3,5000,data_buf,0);
<a name="l00122"></a>00122       <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(4,5000,data_buf,0);
<a name="l00123"></a>00123       <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(5,5000,data_buf,0);
<a name="l00124"></a>00124       <a class="code" href="main_8c.html#a5f07c61e1d5f459a8d6ea62c70449ad" title="&amp;quot;TCP CLIENT&amp;quot; loopback program.">loopback_tcpc</a>(6,serverip, 3000, data_buf,0);
<a name="l00125"></a>00125       <a class="code" href="main_8c.html#ed2243d169a9c70157f547f7ab650dc8" title="UDP loopback program.">loopback_udp</a>(7,3000,data_buf,0);
<a name="l00126"></a>00126    }
<a name="l00127"></a>00127 
<a name="l00128"></a>00128 <span class="preprocessor">   #ifdef __DEF_IINCHIP_PPP__</span>
<a name="l00129"></a>00129 <span class="preprocessor"></span>   {
<a name="l00130"></a>00130       <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> ppp_mac[6];
<a name="l00131"></a>00131       <a class="code" href="w5300_8h.html#ea770e010917e76e65fb0cb9181b4a02" title="It gets the PPPoE server hardware address.">getPDHAR</a>(ppp_mac);
<a name="l00132"></a>00132       <a class="code" href="w5300_8h.html#42e744baf186eb4595953ebc7da084ef" title="It terminates PPPoE connection.">pppterm</a>(ppp_mac, <a class="code" href="w5300_8h.html#0805375bdf0779b8ff8c0acf731fcf03" title="It gets PSIDR value.">getPSIDR</a>());
<a name="l00133"></a>00133    }
<a name="l00134"></a>00134 <span class="preprocessor">   #endif</span>
<a name="l00135"></a>00135 <span class="preprocessor"></span>
<a name="l00136"></a>00136    <span class="keywordflow">while</span>(1);
<a name="l00137"></a>00137 }
<a name="l00138"></a>00138 
<a name="l00139"></a>00139 
<a name="l00140"></a>00140 <span class="keywordtype">void</span> InitXHyper255A(<span class="keywordtype">void</span>)
<a name="l00141"></a>00141 {
<a name="l00142"></a>00142    ADDR32(GPIO_BASE+GPDR2) |= GPDR2_VALUE; <span class="comment">//~0x0;//((ADDR32(GPIO_BASE+GPDR2) &amp; 0x0001FFFF) | GPDR2_VALUE);</span>
<a name="l00143"></a>00143    ADDR32(GPIO_BASE+GAFR2_L) |= GAFR2L_VALUE;
<a name="l00144"></a>00144    ADDR32(MEM_CTL_BASE+MSC1) = 0x00008259;<span class="comment">//0x000095F8;</span>
<a name="l00145"></a>00145 }
<a name="l00146"></a>00146 
<a name="l00162"></a><a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4">00162</a> <span class="keywordtype">void</span>     <a class="code" href="main_8c.html#062f59a52ece70087544ff0ebca079b4" title="&amp;quot;TCP SERVER&amp;quot; loopback program.">loopback_tcps</a>(<a class="code" href="types_8h.html#302434b7916f66d677e9c6f13515de3e" title="The SOCKET data type.">SOCKET</a> s, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> port, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* buf, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mode)
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164    <a class="code" href="types_8h.html#4b435a49c74bb91f284f075e63416cb6">uint32</a> len;
<a name="l00165"></a>00165    
<a name="l00166"></a>00166    <span class="keywordflow">switch</span>(<a class="code" href="w5300_8h.html#fe282f3897d4bb9fd507ebae32d91ef5" title="It gets Sn_SSR value.">getSn_SSR</a>(s))                <span class="comment">// check SOCKET status</span>
<a name="l00167"></a>00167    {                                   <span class="comment">// ------------</span>
<a name="l00168"></a>00168       <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#9cdcdeddeeb7b7bf82bbc5eb415f677c" title="It is the status that TCP connection is established.">SOCK_ESTABLISHED</a>:           <span class="comment">// ESTABLISHED?</span>
<a name="l00169"></a>00169          <span class="keywordflow">if</span>(<a class="code" href="w5300_8h.html#59374b796f37fd0b6a5b5dcd3cb9e0c2" title="It gets Sn_IR value.">getSn_IR</a>(s) &amp; <a class="code" href="w5300_8h.html#ab062cd504413d28bab4ddb338f6ff35" title="Connect bit of Sn_IR.">Sn_IR_CON</a>)   <span class="comment">// check Sn_IR_CON bit</span>
<a name="l00170"></a>00170          {
<a name="l00171"></a>00171             printf(<span class="stringliteral">"%d : Connect OK\r\n"</span>,s);
<a name="l00172"></a>00172             <a class="code" href="w5300_8h.html#e178c212ddad5fa1c1bb58dc283791b9" title="It sets Sn_IR value.">setSn_IR</a>(s,Sn_IR_CON);     <span class="comment">// clear Sn_IR_CON</span>
<a name="l00173"></a>00173          }
<a name="l00174"></a>00174          <span class="keywordflow">if</span>((len=<a class="code" href="w5300_8h.html#a394edd575e56d8df1a86b1acbf99a0d" title="It gets Sn_RX_RSR value.">getSn_RX_RSR</a>(s)) &gt; 0) <span class="comment">// check the size of received data</span>
<a name="l00175"></a>00175          {
<a name="l00176"></a>00176             len = <a class="code" href="socket_8h.html#5672da1c2194f153a238b7e24a0ac435" title="It receives TCP data on a connection SOCKET.">recv</a>(s,buf,len);     <span class="comment">// recv</span>
<a name="l00177"></a>00177             <span class="keywordflow">if</span>(len !=<a class="code" href="socket_8h.html#1679bdae7e6cd6a583576d3a80110095" title="It sends TCP data on a connection SOCKET.">send</a>(s,buf,len))  <span class="comment">// send</span>
<a name="l00178"></a>00178             {
<a name="l00179"></a>00179                printf(<span class="stringliteral">"%d : Send Fail.len=%d\r\n"</span>,s,len);
<a name="l00180"></a>00180             }
<a name="l00181"></a>00181          }
<a name="l00182"></a>00182          <span class="keywordflow">break</span>;
<a name="l00183"></a>00183                                        <span class="comment">// ---------------</span>
<a name="l00184"></a>00184    <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#9375ae181e82024c1ed2d44b4b51a2a6" title="It is the status that disconnect-request(FIN packet) is received from the peer.">SOCK_CLOSE_WAIT</a>:               <span class="comment">// PASSIVE CLOSED</span>
<a name="l00185"></a>00185          <a class="code" href="socket_8h.html#ddfd77bbc2b33e6edbcb8944e6a7e998" title="It tries to disconnect a connection SOCKET with a peer.">disconnect</a>(s);                <span class="comment">// disconnect </span>
<a name="l00186"></a>00186          <span class="keywordflow">break</span>;
<a name="l00187"></a>00187                                        <span class="comment">// --------------</span>
<a name="l00188"></a>00188    <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#8e14b15b210852d2812514526de5c004" title="It is the status that resource of SOCKETn is released.">SOCK_CLOSED</a>:                   <span class="comment">// CLOSED</span>
<a name="l00189"></a>00189       <a class="code" href="socket_8h.html#4243cf1670c850a7bf1e77799afdc53f" title="Close a SOCKET.">close</a>(s);                        <span class="comment">// close the SOCKET</span>
<a name="l00190"></a>00190       <a class="code" href="socket_8h.html#8b0247cecfe600e1e8b0df8ed2e77e79" title="Open a SOCKET.">socket</a>(s,<a class="code" href="w5300_8h.html#111a5f7d5eb14054bd5a895dabad372d" title="Protocol bits of Sn_MR.">Sn_MR_TCP</a>,port,mode);   <span class="comment">// open the SOCKET  </span>
<a name="l00191"></a>00191       <span class="keywordflow">break</span>;
<a name="l00192"></a>00192                                        <span class="comment">// ------------------------------</span>
<a name="l00193"></a>00193    <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#a3ecdc449468d915c67d4a0323a5d21d" title="It is the status that SOCKETn is open as TCP mode.">SOCK_INIT</a>:                     <span class="comment">// The SOCKET opened with TCP mode</span>
<a name="l00194"></a>00194       <a class="code" href="socket_8h.html#98a63bbd78fcd6b0fbbea85c773f0306" title="It is listening to a connect-request from a client.">listen</a>(s);                       <span class="comment">// listen to any connection request from "TCP CLIENT"</span>
<a name="l00195"></a>00195       printf(<span class="stringliteral">"%d : LOOPBACK_TCPS(%d) Started.\r\n"</span>,s,port);
<a name="l00196"></a>00196       <span class="keywordflow">break</span>;
<a name="l00197"></a>00197    <span class="keywordflow">default</span>:
<a name="l00198"></a>00198       <span class="keywordflow">break</span>;
<a name="l00199"></a>00199    }
<a name="l00200"></a>00200 }
<a name="l00201"></a>00201 
<a name="l00218"></a><a class="code" href="main_8c.html#a5f07c61e1d5f459a8d6ea62c70449ad">00218</a> <span class="keywordtype">void</span>     <a class="code" href="main_8c.html#a5f07c61e1d5f459a8d6ea62c70449ad" title="&amp;quot;TCP CLIENT&amp;quot; loopback program.">loopback_tcpc</a>(<a class="code" href="types_8h.html#302434b7916f66d677e9c6f13515de3e" title="The SOCKET data type.">SOCKET</a> s, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* addr, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> port, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* buf, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mode)
<a name="l00219"></a>00219 {
<a name="l00220"></a>00220    <a class="code" href="types_8h.html#4b435a49c74bb91f284f075e63416cb6">uint32</a> len;
<a name="l00221"></a>00221    <span class="keyword">static</span> <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> any_port = 1000;
<a name="l00222"></a>00222    
<a name="l00223"></a>00223    <span class="keywordflow">switch</span>(<a class="code" href="w5300_8h.html#fe282f3897d4bb9fd507ebae32d91ef5" title="It gets Sn_SSR value.">getSn_SSR</a>(s))                   <span class="comment">// check SOCKET status</span>
<a name="l00224"></a>00224    {                                      <span class="comment">// ------------</span>
<a name="l00225"></a>00225       <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#9cdcdeddeeb7b7bf82bbc5eb415f677c" title="It is the status that TCP connection is established.">SOCK_ESTABLISHED</a>:              <span class="comment">// ESTABLISHED?</span>
<a name="l00226"></a>00226          <span class="keywordflow">if</span>(<a class="code" href="w5300_8h.html#59374b796f37fd0b6a5b5dcd3cb9e0c2" title="It gets Sn_IR value.">getSn_IR</a>(s) &amp; <a class="code" href="w5300_8h.html#ab062cd504413d28bab4ddb338f6ff35" title="Connect bit of Sn_IR.">Sn_IR_CON</a>)      <span class="comment">// check Sn_IR_CON bit</span>
<a name="l00227"></a>00227          {
<a name="l00228"></a>00228             printf(<span class="stringliteral">"%d : Connect OK\r\n"</span>,s);
<a name="l00229"></a>00229             <a class="code" href="w5300_8h.html#e178c212ddad5fa1c1bb58dc283791b9" title="It sets Sn_IR value.">setSn_IR</a>(s,Sn_IR_CON);        <span class="comment">// clear Sn_IR_CON</span>
<a name="l00230"></a>00230          }
<a name="l00231"></a>00231          <span class="keywordflow">if</span>((len=<a class="code" href="w5300_8h.html#a394edd575e56d8df1a86b1acbf99a0d" title="It gets Sn_RX_RSR value.">getSn_RX_RSR</a>(s)) &gt; 0)    <span class="comment">// check the size of received data</span>
<a name="l00232"></a>00232          {
<a name="l00233"></a>00233             len = <a class="code" href="socket_8h.html#5672da1c2194f153a238b7e24a0ac435" title="It receives TCP data on a connection SOCKET.">recv</a>(s,buf,len);        <span class="comment">// recv</span>
<a name="l00234"></a>00234             <span class="keywordflow">if</span>(len !=<a class="code" href="socket_8h.html#1679bdae7e6cd6a583576d3a80110095" title="It sends TCP data on a connection SOCKET.">send</a>(s,buf,len))     <span class="comment">// send</span>
<a name="l00235"></a>00235             {
<a name="l00236"></a>00236                printf(<span class="stringliteral">"%d : Send Fail.len=%d\r\n"</span>,s,len);
<a name="l00237"></a>00237             }
<a name="l00238"></a>00238          }
<a name="l00239"></a>00239          <span class="keywordflow">break</span>;
<a name="l00240"></a>00240                                           <span class="comment">// ---------------</span>
<a name="l00241"></a>00241    <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#9375ae181e82024c1ed2d44b4b51a2a6" title="It is the status that disconnect-request(FIN packet) is received from the peer.">SOCK_CLOSE_WAIT</a>:                  <span class="comment">// PASSIVE CLOSED</span>
<a name="l00242"></a>00242          <a class="code" href="socket_8h.html#ddfd77bbc2b33e6edbcb8944e6a7e998" title="It tries to disconnect a connection SOCKET with a peer.">disconnect</a>(s);                   <span class="comment">// disconnect </span>
<a name="l00243"></a>00243          <span class="keywordflow">break</span>;
<a name="l00244"></a>00244                                           <span class="comment">// --------------</span>
<a name="l00245"></a>00245    <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#8e14b15b210852d2812514526de5c004" title="It is the status that resource of SOCKETn is released.">SOCK_CLOSED</a>:                      <span class="comment">// CLOSED</span>
<a name="l00246"></a>00246       <a class="code" href="socket_8h.html#4243cf1670c850a7bf1e77799afdc53f" title="Close a SOCKET.">close</a>(s);                           <span class="comment">// close the SOCKET</span>
<a name="l00247"></a>00247       <a class="code" href="socket_8h.html#8b0247cecfe600e1e8b0df8ed2e77e79" title="Open a SOCKET.">socket</a>(s,<a class="code" href="w5300_8h.html#111a5f7d5eb14054bd5a895dabad372d" title="Protocol bits of Sn_MR.">Sn_MR_TCP</a>,any_port++,mode);<span class="comment">// open the SOCKET with TCP mode and any source port number</span>
<a name="l00248"></a>00248       <span class="keywordflow">break</span>;
<a name="l00249"></a>00249                                           <span class="comment">// ------------------------------</span>
<a name="l00250"></a>00250    <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#a3ecdc449468d915c67d4a0323a5d21d" title="It is the status that SOCKETn is open as TCP mode.">SOCK_INIT</a>:                        <span class="comment">// The SOCKET opened with TCP mode</span>
<a name="l00251"></a>00251       <a class="code" href="socket_8h.html#6b113f87d2f4dde2a5db37b36505c2df" title="It tries to connect a client.">connect</a>(s, addr, port);             <span class="comment">// Try to connect to "TCP SERVER"</span>
<a name="l00252"></a>00252       printf(<span class="stringliteral">"%d : LOOPBACK_TCPC(%d.%d.%d.%d:%d) Started.\r\n"</span>,s,addr[0],addr[1],addr[2],addr[3],port);
<a name="l00253"></a>00253       <span class="keywordflow">break</span>;
<a name="l00254"></a>00254    <span class="keywordflow">default</span>:
<a name="l00255"></a>00255       <span class="keywordflow">break</span>;
<a name="l00256"></a>00256    }
<a name="l00257"></a>00257 }
<a name="l00258"></a>00258 
<a name="l00274"></a><a class="code" href="main_8c.html#ed2243d169a9c70157f547f7ab650dc8">00274</a> <span class="keywordtype">void</span>     <a class="code" href="main_8c.html#ed2243d169a9c70157f547f7ab650dc8" title="UDP loopback program.">loopback_udp</a>(<a class="code" href="types_8h.html#302434b7916f66d677e9c6f13515de3e" title="The SOCKET data type.">SOCKET</a> s, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> port, <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a>* buf, <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> mode)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276    <a class="code" href="types_8h.html#4b435a49c74bb91f284f075e63416cb6">uint32</a> len;
<a name="l00277"></a>00277    <a class="code" href="types_8h.html#dde6aaee8457bee49c2a92621fe22b79">uint8</a> destip[4];
<a name="l00278"></a>00278    <a class="code" href="types_8h.html#05f6b0ae8f6a6e135b0e290c25fe0e4e">uint16</a> destport;
<a name="l00279"></a>00279    
<a name="l00280"></a>00280    <span class="keywordflow">switch</span>(<a class="code" href="w5300_8h.html#fe282f3897d4bb9fd507ebae32d91ef5" title="It gets Sn_SSR value.">getSn_SSR</a>(s))
<a name="l00281"></a>00281    {
<a name="l00282"></a>00282                                                          <span class="comment">// -------------------------------</span>
<a name="l00283"></a>00283       <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#ed90ae30cba33085bfc6a7212356c33a" title="It is the status that SOCKETn is open as UDP mode.">SOCK_UDP</a>:                                     <span class="comment">// </span>
<a name="l00284"></a>00284          <span class="keywordflow">if</span>((len=<a class="code" href="w5300_8h.html#a394edd575e56d8df1a86b1acbf99a0d" title="It gets Sn_RX_RSR value.">getSn_RX_RSR</a>(s)) &gt; 0)                   <span class="comment">// check the size of received data</span>
<a name="l00285"></a>00285          {
<a name="l00286"></a>00286             len = <a class="code" href="socket_8h.html#fb55f9f683d86303d095d6df2d18bffd" title="It receives UDP, IPRAW, or MACRAW data.">recvfrom</a>(s,buf,len,destip,&amp;destport);  <span class="comment">// receive data from a destination</span>
<a name="l00287"></a>00287             <span class="keywordflow">if</span>(len !=<a class="code" href="socket_8h.html#0673e6e4b3c74bf6f5a38ece483e8f55" title="It sends UDP, IPRAW, or MACRAW data.">sendto</a>(s,buf,len,destip,destport))  <span class="comment">// send the data to the destination</span>
<a name="l00288"></a>00288             {
<a name="l00289"></a>00289                printf(<span class="stringliteral">"%d : Sendto Fail.len=%d,"</span>,s,len);
<a name="l00290"></a>00290                printf(<span class="stringliteral">"%d.%d.%d.%d(%d)\r\n"</span>,destip[0],destip[1],destip[2],destip[3],destport);
<a name="l00291"></a>00291             }
<a name="l00292"></a>00292          }
<a name="l00293"></a>00293          <span class="keywordflow">break</span>;
<a name="l00294"></a>00294                                                          <span class="comment">// -----------------</span>
<a name="l00295"></a>00295       <span class="keywordflow">case</span> <a class="code" href="w5300_8h.html#8e14b15b210852d2812514526de5c004" title="It is the status that resource of SOCKETn is released.">SOCK_CLOSED</a>:                                  <span class="comment">// CLOSED</span>
<a name="l00296"></a>00296          <a class="code" href="socket_8h.html#4243cf1670c850a7bf1e77799afdc53f" title="Close a SOCKET.">close</a>(s);                                       <span class="comment">// close the SOCKET</span>
<a name="l00297"></a>00297          <a class="code" href="socket_8h.html#8b0247cecfe600e1e8b0df8ed2e77e79" title="Open a SOCKET.">socket</a>(s,<a class="code" href="w5300_8h.html#1a31c891ae1c9cf808542b96ae8fdeb8" title="Protocol bits of Sn_MR.">Sn_MR_UDP</a>,port,mode);                  <span class="comment">// open the SOCKET with UDP mode</span>
<a name="l00298"></a>00298          <span class="keywordflow">break</span>;
<a name="l00299"></a>00299       <span class="keywordflow">default</span>:
<a name="l00300"></a>00300          <span class="keywordflow">break</span>;
<a name="l00301"></a>00301    }
<a name="l00302"></a>00302 }
</pre></div></div>
<hr size="1"><address style="text-align: right;"><small>Generated on Fri Jan 2 12:19:59 2009 for W5300 - SOCKET APIs by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border="0"></a> 1.5.6 </small></address>
</body>
</html>
