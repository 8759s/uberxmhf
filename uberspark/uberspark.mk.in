######
# top-level Makefile for UberSpark
# author: amit vasudevan (amitvasudevan@acm.org)
######


include ./uberspark-common.mk


###### targets

.PHONY: all
all: build-tools
	@echo $(AC_PREFIX)
	@echo $(AC_BINDIR)
	@echo $(AC_LIBDIR)
	@echo $(AC_INCLUDEDIR)
	@echo $(AC_DATADIR)
	@echo $(USPARK_DIR)
	@echo $(USPARK_OBJDIR)
	@echo $(USPARK_HWMDIR)
	@echo $(USPARK_LIBSDIR)
	@echo $(USPARK_INCLUDEDIR)
	@echo $(USPARK_TOOLSDIR)


.PHONY: build-tools
build-tools:
	cd $(USPARK_TOOLSDIR) && $(OCAMLC) -o ubersparkconfig unix.cma ubersparkconfig.ml
	cd $(USPARK_TOOLSDIR) && $(RM) umfcommon.annot umfcommon.cmi umfcommon.cmo umfcommon.cmt umfcommon.cmx umfcommon.o
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f umf.mk -w all
	cd $(USPARK_TOOLSDIR) && $(RM) umfcommon.annot umfcommon.cmi umfcommon.cmo umfcommon.cmt umfcommon.cmx umfcommon.o
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f ubp.mk -w all
	cd $(USPARK_TOOLSDIR) && $(RM) umfcommon.annot umfcommon.cmi umfcommon.cmo umfcommon.cmt umfcommon.cmx umfcommon.o
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f uccomp.mk -w all
	cd $(USPARK_TOOLSDIR) && $(RM) umfcommon.annot umfcommon.cmi umfcommon.cmo umfcommon.cmt umfcommon.cmx umfcommon.o
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f ucasm.mk -w all
	cd $(USPARK_TOOLSDIR) && $(RM) umfcommon.annot umfcommon.cmi umfcommon.cmo umfcommon.cmt umfcommon.cmx umfcommon.o
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f uhwm.mk -w all
	

.PHONY: install-tools
install-tools:
	$(MKDIR) -p $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools
	$(CP) -f $(USPARK_TOOLSDIR)/ubersparkconfig $(AC_PREFIX)$(AC_BINDIR)/.
	$(CP) -f $(USPARK_TOOLSDIR)/Umf.cmi $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Umf.cmx $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Umf.cmo $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Umf.o $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ubp.cmi $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ubp.cmx $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ubp.cmo $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ubp.o $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uccomp.cmi $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uccomp.cmx $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uccomp.cmo $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uccomp.o $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ucasm.cmi $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ucasm.cmx $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ucasm.cmo $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Ucasm.o $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uhwm.cmi $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uhwm.cmx $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uhwm.cmo $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.
	$(CP) -f $(USPARK_TOOLSDIR)/Uhwm.o $(AC_PREFIX)$(AC_LIBDIR)/uberspark/tools/.


.PHONY: install-hdrs
install-hdrs:
	$(MKDIR) -p $(AC_PREFIX)$(AC_LIBDIR)/uberspark/include
	$(CP) -f $(USPARK_INCLUDEDIR)/* $(AC_PREFIX)$(AC_LIBDIR)/uberspark/include/.

.PHONY: install-hwm
install-hwm:
	$(MKDIR) -p $(AC_PREFIX)$(AC_LIBDIR)/uberspark/hwm
	$(CP) -rf $(USPARK_HWMDIR)/* $(AC_PREFIX)$(AC_LIBDIR)/uberspark/hwm/.



.PHONY: clean
clean:
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f umf.mk -w clean
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f ubp.mk -w clean
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f uccomp.mk -w clean
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f ucasm.mk -w clean
	cd $(USPARK_TOOLSDIR) && $(MAKE) -f uhwm.mk -w clean
	cd $(USPARK_TOOLSDIR) && $(RM) *_DEP
	

# http://www.gnu.org/software/automake/manual/automake.html#Clean
.PHONY: distclean
distclean: clean
	$(RM) config.log config.status
	$(RM) uberspark.mk
	$(RM) uberspark-common.mk


###### autoconf rules

uberspark.mk: uberspark.mk.in config.status
	./config.status $@

config.status: configure-uberspark
	./config.status --recheck

configure-uberspark: configure-uberspark.ac
	autoconf --output=configure-uberspark configure-uberspark.ac

